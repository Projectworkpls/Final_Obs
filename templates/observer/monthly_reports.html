{% extends "base.html" %}

{% block title %}Monthly Reports{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar me-2"></i>Monthly Reports
        </h1>
        <p class="text-muted">Generate comprehensive monthly progress reports for your assigned children.</p>
    </div>
</div>

<div class="row">
    <!-- Report Generation -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>Generate Monthly Report</h5>
            </div>
            <div class="card-body">
                <form id="monthly-report-form">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="monthly-child-select" class="form-label">Select Child</label>
                                <select class="form-select" id="monthly-child-select" name="child_id" required>
                                    <option value="">Choose a child</option>
                                    {% for child in children %}
                                    <option value="{{ child.id }}">{{ child.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="monthly-year" class="form-label">Year</label>
                                <select class="form-select" id="monthly-year" name="year" required>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                    <option value="2026">2026</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="monthly-month" class="form-label">Month</label>
                                <select class="form-select" id="monthly-month" name="month" required>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5" selected>May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-primary btn-lg" onclick="generateMonthlyReport(event)">
                        <i class="fas fa-chart-bar me-2"></i>Generate Report
                    </button>
                </form>
            </div>
        </div>

        <!-- REVISED Monthly Report Display -->
        <div id="monthly-report-section" class="card mt-4" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-chart-line me-2"></i>Monthly Report</h5>
                <div class="btn-group">
                    <button class="btn btn-outline-primary btn-sm" onclick="downloadMonthlyReport('word')">
                        <i class="fas fa-download me-1"></i>Download Word
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="downloadMonthlyReport('pdf')">
                        <i class="fas fa-file-pdf me-1"></i>Download PDF
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="emailMonthlyReport()">
                        <i class="fas fa-envelope me-1"></i>Email
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- The entire enhanced report will be injected here by JS -->
                <div id="monthly-report-content" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; max-width: 900px; margin: 0 auto;"></div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Report Information</h5>
            </div>
            <div class="card-body">
                <p>Monthly reports provide comprehensive insights into a child's progress over a specific month.</p>

                <h6>Includes:</h6>
                <ul>
                    <li>Observation frequency analysis</li>
                    <li>Strength patterns</li>
                    <li>Development area trends</li>
                    <li>Goal progress tracking</li>
                    <li>Downloadable Word & PDF reports</li>
                    <li>Email sharing capability</li>
                </ul>

                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    Reports can be shared directly with parents via email.
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card mt-3">
            <div class="card-header">
                <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('observer.dashboard') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-home me-1"></i>Back to Dashboard
                    </a>
                    <a href="{{ url_for('observer.process_observation') }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-camera me-1"></i>Process Observation
                    </a>
                    <a href="{{ url_for('observer.goals') }}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-bullseye me-1"></i>Manage Goals
                    </a>
                </div>
            </div>
        </div>

        <!-- Processing Status -->
        <div class="card mt-3" id="processing-status" style="display: none;">
            <div class="card-header">
                <h5><i class="fas fa-cogs me-2"></i>Processing Status</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-2">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="status-text">Ready to generate...</small>
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Monthly Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="email-form">
                    <div class="mb-3">
                        <label for="recipient-email" class="form-label">Recipient Email</label>
                        <input type="email" class="form-control" id="recipient-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="email-subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="email-subject" value="Monthly Observation Report">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendEmail()">Send Email</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="successToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-check-circle text-success me-2"></i>
            <strong class="me-auto">Success</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="successMessage"></div>
    </div>

    <div id="errorToast" class="toast" role="alert">
        <div class="toast-header">
            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
            <strong class="me-auto">Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="errorMessage"></div>
    </div>
</div>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-2px);
}

.processing-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.processing-spinner {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
}
</style>

<script>
let processingInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set current month as default
    const currentMonth = new Date().getMonth() + 1;
    document.getElementById('monthly-month').value = currentMonth;
});

function generateMonthlyReport(event) {
    const childId = document.getElementById('monthly-child-select').value;
    const year = document.getElementById('monthly-year').value;
    const month = document.getElementById('monthly-month').value;

    if (!childId || !year || !month) {
        showAlert('Please select all required fields', 'warning');
        return;
    }

    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;

    showProcessingStatus();

    const formData = new FormData();
    formData.append('child_id', childId);
    formData.append('year', year);
    formData.append('month', month);

    fetch('/observer/generate_monthly_report', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideProcessingStatus();

        if (!(data.success || data.summary)) {
            showToast('error', data.error || "Error generating monthly report");
            return;
        }

        // Parse and order the summary data
        let summaryData;
        try {
            let summaryText = data.summary || '';
            summaryText = summaryText.replace(/^Monthly Summary\s*/i, '');
            const jsonStart = summaryText.indexOf('{');
            const jsonEnd = summaryText.lastIndexOf('}');
            if (jsonStart !== -1 && jsonEnd !== -1) {
                const jsonString = summaryText.substring(jsonStart, jsonEnd + 1);
                summaryData = JSON.parse(jsonString);
            } else {
                throw new Error('No JSON found');
            }
        } catch (e) {
            summaryData = { observations: data.summary || "No data available." };
        }

        // Build the output in the order requested
        let reportHtml = '';

        // Student Info Header (always)
        reportHtml += `
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>Student Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Name:</strong> ${summaryData.studentName || '-'}</p>
                        <p><strong>Period:</strong> ${summaryData.date || '-'}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Report Type:</strong> ${summaryData.className || '-'}</p>
                        <p><strong>Report ID:</strong> ${summaryData.studentId || '-'}</p>
                    </div>
                </div>
            </div>
        </div>`;

        // 1. Progress Insights FIRST
        if (summaryData.progressInsights && summaryData.progressInsights.length > 0) {
            reportHtml += `
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Progress Insights</h5>
                </div>
                <div class="card-body">
                    <ul>
                        ${summaryData.progressInsights.map(insight => `<li>${insight}</li>`).join('')}
                    </ul>
                </div>
            </div>`;
        }

        // 2. Strengths Observed
        reportHtml += `
        <div class="card mb-4">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-star me-2"></i>Strengths Observed</h5>
            </div>
            <div class="card-body">
                ${summaryData.strengths && summaryData.strengths.length > 0 ? `
                    <ul class="list-unstyled">
                        ${summaryData.strengths.map(strength =>
            `<li class="mb-2">
                <i class="fas fa-check-circle text-success me-2"></i>${strength}
            </li>`).join('')}
                    </ul>
                ` : '<p class="text-muted"><i class="fas fa-info-circle me-2"></i>No specific strengths data available for this period.</p>'}
            </div>
        </div>`;

        // 3. Communication Skills TABLE
        if (summaryData.communicationSkills) {
            reportHtml += `
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Communication Skills</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-dark">
                        <tr>
                            <th>Skill</th>
                            <th>Rating</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td>Confidence Level</td>
                            <td>${capitalize(summaryData.communicationSkills.confidence)}</td>
                        </tr>
                        <tr>
                            <td>Clarity of Thought</td>
                            <td>${capitalize(summaryData.communicationSkills.clarity)}</td>
                        </tr>
                        <tr>
                            <td>Participation & Engagement</td>
                            <td>${capitalize(summaryData.communicationSkills.participation)}</td>
                        </tr>
                        <tr>
                            <td>Sequence of Explanation</td>
                            <td>${capitalize(summaryData.communicationSkills.sequencing)}</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        // 4. Growth Metrics TABLE
        if (summaryData.growthMetrics) {
            reportHtml += `
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Growth Metrics</h5>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-dark">
                        <tr>
                            <th>Area</th>
                            <th>Rating</th>
                        </tr>
                        </thead>
                        <tbody>
                        ${Object.entries(summaryData.growthMetrics || {})
                            .map(([area, rating]) =>
                                `<tr><td>${area}</td><td>${capitalize(rating)}</td></tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        // 5. Areas for Development
        reportHtml += `
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-arrow-up me-2"></i>Areas for Development</h5>
            </div>
            <div class="card-body">
                ${summaryData.areasOfDevelopment && summaryData.areasOfDevelopment.length > 0 ? `
                    <ul class="list-unstyled">
                        ${summaryData.areasOfDevelopment.map(area =>
            `<li class="mb-2">
                <i class="fas fa-arrow-circle-up text-warning me-2"></i>${area}
            </li>`).join('')}
                    </ul>
                ` : '<p class="text-muted"><i class="fas fa-info-circle me-2"></i>No specific development areas identified for this period.</p>'}
            </div>
        </div>`;

        // 6. Recommendations (heading: Recommendation)
        reportHtml += `
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recommendation</h5>
            </div>
            <div class="card-body">
                ${summaryData.recommendations && summaryData.recommendations.length > 0 ? `
                    <ul>
                        ${summaryData.recommendations.map(rec =>
            `<li class="mb-2">${rec}</li>`).join('')}
                    </ul>
                ` : '<p class="text-muted">No specific recommendations available.</p>'}
            </div>
        </div>`;

        // Insert into DOM
        document.getElementById('monthly-report-content').innerHTML = reportHtml;
        document.getElementById('monthly-report-section').style.display = 'block';

        showToast('success', 'Monthly report generated successfully!');

        function capitalize(value) {
            if (!value) return 'No data';
            return value.charAt(0).toUpperCase() + value.slice(1);
        }
    })
    .catch(error => {
        hideProcessingStatus();
        showToast('error', 'Error generating monthly report');
        console.error('Error:', error);
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showProcessingStatus() {
    const statusCard = document.getElementById('processing-status');
    const progressBar = statusCard.querySelector('.progress-bar');
    const statusText = document.getElementById('status-text');

    statusCard.style.display = 'block';
    let progress = 0;

    const steps = [
        'Collecting data...',
        'Analyzing observations...',
        'Generating report...',
        'Finalizing...'
    ];

    let stepIndex = 0;
    statusText.textContent = steps[stepIndex];

    processingInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;

        progressBar.style.width = progress + '%';

        if (progress > 25 && stepIndex === 0) {
            stepIndex = 1;
            statusText.textContent = steps[stepIndex];
        } else if (progress > 50 && stepIndex === 1) {
            stepIndex = 2;
            statusText.textContent = steps[stepIndex];
        } else if (progress > 75 && stepIndex === 2) {
            stepIndex = 3;
            statusText.textContent = steps[stepIndex];
        }
    }, 500);
}

function hideProcessingStatus() {
    if (processingInterval) {
        clearInterval(processingInterval);
        processingInterval = null;
    }

    const statusCard = document.getElementById('processing-status');
    const progressBar = statusCard.querySelector('.progress-bar');
    const statusText = document.getElementById('status-text');

    progressBar.style.width = '100%';
    statusText.textContent = 'Complete!';

    setTimeout(() => {
        statusCard.style.display = 'none';
        progressBar.style.width = '0%';
        statusText.textContent = 'Ready to generate...';
    }, 1000);
}

function downloadMonthlyReport(type) {
    const url = type === 'word' ? '/observer/download_monthly_report?filetype=docx' : '/observer/download_monthly_report?filetype=pdf';
    window.open(url, '_blank');
}

function emailMonthlyReport() {
    const modal = new bootstrap.Modal(document.getElementById('emailModal'));
    modal.show();
}

function sendEmail() {
    const email = document.getElementById('recipient-email').value;

    if (!email) {
        showToast('error', 'Please enter an email address');
        return;
    }

    const formData = new FormData();
    formData.append('recipient_email', email);

    fetch('/observer/email_monthly_report', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Email sent successfully!');
            bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
        } else {
            showToast('error', 'Error sending email: ' + data.error);
        }
    })
    .catch(error => {
        showToast('error', 'Error sending email');
        console.error('Error:', error);
    });
}

function showToast(type, message) {
    const toastId = type === 'success' ? 'successToast' : 'errorToast';
    const messageId = type === 'success' ? 'successMessage' : 'errorMessage';

    document.getElementById(messageId).textContent = message;

    const toast = new bootstrap.Toast(document.getElementById(toastId));
    toast.show();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
