{% extends "base.html" %}
{% block title %}Peer Reviews & Observer Feedback - Principal{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-clipboard-check me-2"></i>Peer Reviews & Observer Feedback</h2>
        <a href="{{ url_for('principal.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <!-- AI Review Notifications -->
    {% if notifications %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-robot me-2"></i>
        <strong>New AI Reviews Available!</strong>
        You have {{ notifications|length }} new AI communication review{{ 's' if notifications|length > 1 else '' }} ready for analysis.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- Debug Information -->
    <div class="alert alert-info">
        <strong>Debug Info:</strong>
        Found {{ peer_reviews|length }} peer reviews for your organization.
        {{ observers|length }} observers in your organization.
        <a href="{{ url_for('principal.debug_peer_reviews') }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
            View Debug Data
        </a>
    </div>

    <!-- Peer Reviews Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-users me-2"></i>Cross-Organization Peer Reviews ({{ peer_reviews|length }})</h5>
        </div>
        <div class="card-body">
            {% if peer_reviews %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Student</th>
                            <th>Observer (Your Org)</th>
                            <th>Reviewer</th>
                            <th>Reviewer Org</th>
                            <th>Requires Changes</th>
                            <th>Comments</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for review in peer_reviews %}
                        <tr>
                            <td>{{ review.observation.student_name if review.observation else 'N/A' }}</td>
                            <td>{{ review.observation.observer_name if review.observation else 'N/A' }}</td>
                            <td>{{ review.reviewer_info.name if review.reviewer_info else 'Unknown' }}</td>
                            <td>
                                <span class="badge bg-info">
                                    {{ review.reviewer_info.organization_id[:8] if review.reviewer_info.organization_id else 'N/A' }}...
                                </span>
                            </td>
                            <td>
                                {% if review.requires_changes %}
                                    <span class="badge bg-warning">Yes</span>
                                {% else %}
                                    <span class="badge bg-success">No</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="showComments('{{ review.id }}')">
                                    View Comments
                                </button>
                                <div id="comments-{{ review.id }}" style="display: none;" class="mt-2">
                                    <strong>Comments:</strong> {{ review.review_comments }}<br>
                                    {% if review.suggested_improvements %}
                                    <strong>Improvements:</strong> {{ review.suggested_improvements }}
                                    {% endif %}
                                </div>
                            </td>
                            <td>{{ review.created_at[:10] if review.created_at else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No peer reviews found</h5>
                <p class="text-muted">
                    Cross-organization peer reviews for your organization's observations will appear here.<br>
                    <small>Make sure your observers have submitted observations and other observers have reviewed them.</small>
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Send Feedback to Observer Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-comment-dots me-2"></i>Send Feedback to Observer</h5>
        </div>
        <div class="card-body">
            {% if observers %}
            <form method="POST" action="{{ url_for('principal.send_peer_review_feedback') }}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="observer_id" class="form-label">Select Observer</label>
                        <select class="form-select" id="observer_id" name="observer_id" required>
                            <option value="">Choose Observer...</option>
                            {% for observer in observers %}
                            <option value="{{ observer.id }}">{{ observer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="feedback_type" class="form-label">Feedback Type</label>
                        <select class="form-select" id="feedback_type" name="feedback_type" required>
                            <option value="">Select Type...</option>
                            <option value="positive">Positive</option>
                            <option value="Constructive">Constructive</option>
                            <option value="Improvement">Improvement</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label for="feedback_text" class="form-label">Feedback Message</label>
                        <textarea class="form-control" id="feedback_text" name="feedback_text" rows="2"
                                placeholder="Enter your feedback for the observer..." required></textarea>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-paper-plane me-1"></i>Send Feedback
                        </button>
                    </div>
                </div>
            </form>
            {% else %}
            <p class="text-muted">No observers found in your organization.</p>
            {% endif %}
        </div>
    </div>

    <!-- Automatic AI Reviews Section -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-robot me-2"></i>üîç Automatic AI Reviews of Observer‚ÄìStudent Conversations</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Only observations with an AI review are listed below.</p>
            {% if auto_reviews %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width:120px;">Date</th>
                            <th style="width:210px;">Student</th>
                            <th style="width:210px;">Observer</th>
                            <th>AI Review (Preview)</th>
                            <th style="width:230px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obs in auto_reviews %}
                        <tr>
                            <td>{{ obs.date }}</td>
                            <td>{{ obs.student_name }}</td>
                            <td>{{ obs.observer_name }}</td>
                            <td>
                                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#ai_review_{{ obs.id }}">
                                    View AI Review
                                </button>
                                <div id="ai_review_{{ obs.id }}" class="collapse mt-2">
                                    <div class="border rounded p-4 ai-review-box">
                                        <article class="ai-review-content formatted-review">{{ obs.communication_review }}</article>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <a class="btn btn-sm btn-secondary" href="{{ url_for('principal.download_ai_review_docx', observation_id=obs.id) }}">
                                        Download DOCX
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#emailAIReviewModal" data-observation="{{ obs.id }}">
                                        Email
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="text-center text-muted">No AI reviews available yet.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-robot fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No AI reviews available for your organization</h5>
                <p class="text-muted">AI reviews of observer-student conversations will appear here once they are generated.</p>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        This could mean:
                    </small>
                    <ul class="list-unstyled mt-2 text-muted small">
                        <li><i class="fas fa-check-circle text-success me-1"></i>No observations have been processed for AI review yet</li>
                        <li><i class="fas fa-check-circle text-success me-1"></i>Observations are still being processed</li>
                        <li><i class="fas fa-check-circle text-success me-1"></i>AI review generation is pending</li>
                    </ul>
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('principal.debug_ai_reviews') }}" class="btn btn-outline-info btn-sm me-2">
                        <i class="fas fa-bug me-1"></i>Debug AI Review Status
                    </a>
                    <button onclick="generateAIReviews()" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-magic me-1"></i>Generate AI Reviews
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Email Modal -->
    <div class="modal fade" id="emailAIReviewModal" tabindex="-1" aria-labelledby="emailAIReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="emailAIReviewModalLabel">Email AI Review</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="emailAIReviewForm">
                    <div class="modal-body">
                        <input type="hidden" id="email_ai_observation_id" name="observation_id">
                        <div class="mb-3">
                            <label for="recipient_email" class="form-label">Recipient Email</label>
                            <input type="email" class="form-control" id="recipient_email" name="recipient_email" required>
                        </div>
                        <div class="mb-3">
                            <label for="message" class="form-label">Additional Message (Optional)</label>
                            <textarea class="form-control" id="message" name="message" rows="3" placeholder="Add any additional context or message..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Observer Feedback History Section -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-history me-2"></i>Observer Feedback History ({{ principal_feedback|length }})</h5>
        </div>
        <div class="card-body">
            {% if principal_feedback %}
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Observer</th>
                            <th>Feedback Type</th>
                            <th>Feedback</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for feedback in principal_feedback %}
                        <tr>
                            <td>
                                {% for user in users %}
                                    {% if user.id == feedback.observer_id %}{{ user.name }}{% endif %}
                                {% endfor %}
                            </td>
                            <td>
                                <span class="badge bg-{% if feedback.feedback_type == 'positive' %}success{% elif feedback.feedback_type == 'constructive' %}warning{% else %}info{% endif %}">
                                    {{ feedback.feedback_type|title }}
                                </span>
                            </td>
                            <td>{{ feedback.feedback_text }}</td>
                            <td>{{ feedback.created_at[:10] if feedback.created_at else 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No feedback history</h5>
                <p class="text-muted">Feedback sent to observers will appear here.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.ai-review-box {
    max-height: 500px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #e3e6f0 !important;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    border-radius: 8px;
}
.ai-review-content {
    white-space: pre-line;
    line-height: 1.7;
    font-size: 0.95rem;
    color: #333;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 8px;
}
.ai-review-content .ai-review-p {
    margin-bottom: 1rem;
    line-height: 1.6;
}
.ai-review-content .ai-review-h1 {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 1.5rem 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3498db;
}
.ai-review-content .ai-review-h2 {
    font-size: 1.2rem;
    font-weight: 600;
    color: #34495e;
    margin: 1.2rem 0 0.8rem 0;
    padding-left: 0.5rem;
    border-left: 3px solid #3498db;
}
.ai-review-content .ai-review-h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin: 1rem 0 0.6rem 0;
}
.ai-review-content .ai-review-strong {
    font-weight: 700;
    color: #2c3e50;
}
.ai-review-content .ai-review-em {
    font-style: italic;
    color: #7f8c8d;
}
.ai-review-content .ai-review-ul, .ai-review-content .ai-review-ol {
    padding-left: 1.5rem;
    margin: 0.8rem 0;
}
.ai-review-content .ai-review-li {
    margin-bottom: 0.4rem;
    line-height: 1.5;
}
.ai-review-content .ai-review-ul .ai-review-li {
    list-style-type: disc;
}
.ai-review-content .ai-review-ol .ai-review-li {
    list-style-type: decimal;
}
.ai-review-content table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
    font-size: 0.9rem;
    border: 1px solid #e1e8ed;
    border-radius: 6px;
    overflow: hidden;
}
.ai-review-content table th, .ai-review-content table td {
    border: 1px solid #e1e8ed;
    padding: 0.75rem;
    vertical-align: top;
    text-align: left;
}
.ai-review-content table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}
.ai-review-content table tr:nth-child(even) {
    background-color: #f8f9fa;
}
.ai-review-content table tr:hover {
    background-color: #e9ecef;
}
.ai-review-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #e83e8c;
}
.ai-review-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    overflow-x: auto;
    border: 1px solid #e9ecef;
    margin: 1rem 0;
}

/* Professional Report Formatting Styles */
.review-document-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #2c3e50;
    text-align: center;
    margin: 0 0 1.5rem 0;
    padding: 1rem 0;
    border-bottom: 2px solid #3498db;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 8px 8px 0 0;
}

.review-section-heading {
    font-size: 1.2rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 2rem 0 1rem 0;
    padding: 0.8rem 1rem;
    background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
    color: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(52, 73, 94, 0.2);
}

.review-numbered-section {
    font-size: 1.1rem;
    font-weight: 600;
    color: #34495e;
    margin: 1.5rem 0 0.8rem 0;
    padding: 0.6rem 1rem;
    background: linear-gradient(135deg, #ecf0f1 0%, #bdc3c7 100%);
    border-left: 4px solid #3498db;
    border-radius: 4px;
}

.review-red-flag {
    font-weight: 600;
    color: #e74c3c;
    margin: 1rem 0 0.5rem 0;
    padding: 0.5rem 1rem;
    background: rgba(231, 76, 60, 0.1);
    border-left: 4px solid #e74c3c;
    border-radius: 4px;
}

.review-bullet {
    margin: 0.8rem 0 0.4rem 0;
    padding: 0.4rem 0 0.4rem 1.5rem;
    line-height: 1.6;
    position: relative;
}

.review-sub-bullet {
    margin: 0.6rem 0 0.3rem 0;
    padding: 0.3rem 0 0.3rem 2.5rem;
    line-height: 1.6;
    color: #555;
    position: relative;
}

.review-sub-sub-bullet {
    margin: 0.4rem 0 0.2rem 0;
    padding: 0.2rem 0 0.2rem 3.5rem;
    line-height: 1.6;
    color: #666;
    font-size: 0.95rem;
    position: relative;
}

.review-bold {
    font-weight: 700;
    color: #2c3e50;
}

.review-italic {
    font-style: italic;
    color: #7f8c8d;
    background: rgba(127, 140, 141, 0.1);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
}

.review-paragraph {
    margin-bottom: 1rem;
    line-height: 1.7;
    text-align: justify;
    color: #333;
}

/* Table Styling */
.review-table-header {
    font-weight: 700;
    color: #2c3e50;
    margin: 1.5rem 0 0.8rem 0;
    padding: 0.8rem 1rem;
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    color: white;
    border-radius: 6px 6px 0 0;
    display: grid;
    grid-template-columns: 1fr 0.5fr 1fr 2fr;
    gap: 1rem;
}

.review-table-row {
    display: grid;
    grid-template-columns: 1fr 0.5fr 1fr 2fr;
    gap: 1rem;
    padding: 0.6rem 1rem;
    border-bottom: 1px solid #e9ecef;
    background: #fff;
    line-height: 1.5;
}

.review-table-row:nth-child(even) {
    background: #f8f9fa;
}

.review-table-row:hover {
    background: #e3f2fd;
}

.review-date {
    font-weight: 600;
    color: #2c3e50;
}

.review-status {
    font-weight: 700;
    font-size: 1.1rem;
}

.review-description {
    color: #555;
    font-size: 0.95rem;
}
.ai-review-content blockquote {
    border-left: 4px solid #3498db;
    padding-left: 1rem;
    margin: 1rem 0;
    color: #6c757d;
    font-style: italic;
}


</style>

<script>
function showComments(reviewId) {
    const commentsDiv = document.getElementById('comments-' + reviewId);
    if (commentsDiv.style.display === 'none') {
        commentsDiv.style.display = 'block';
    } else {
        commentsDiv.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const emailModal = document.getElementById('emailAIReviewModal');
    if (emailModal) {
        emailModal.addEventListener('show.bs.modal', function (event) {
            const btn = event.relatedTarget;
            const obsId = btn ? btn.getAttribute('data-observation') : '';
            document.getElementById('email_ai_observation_id').value = obsId;
        });
    }
    
    const form = document.getElementById('emailAIReviewForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const fd = new FormData(form);
            const resp = await fetch('{{ url_for("principal.email_ai_review") }}', {
                method:'POST',
                body: fd
            });
            const data = await resp.json();
            if (data.success) {
                alert('Email sent successfully.');
                const modal = bootstrap.Modal.getInstance(document.getElementById('emailAIReviewModal'));
                modal.hide();
                form.reset();
            } else {
                alert('Failed to send email: ' + (data.error || data.message || 'Unknown error'));
            }
        });
    }
    
    // Format AI review content
    formatAIReviewContent();
    
    // Also format when collapse is shown
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        button.addEventListener('click', function() {
            setTimeout(() => {
                formatAIReviewContent();
            }, 100);
        });
    });
});

function formatAIReviewContent() {
    const reviewElements = document.querySelectorAll('.ai-review-content.formatted-review');
    
    reviewElements.forEach(element => {
        let content = element.textContent;
        
        // Format the content with professional report styling
        content = content
            // Convert main title (first line) to document title
            .replace(/^([^#\n]+?)(?=\n|$)/, '<div class="review-document-title">$1</div>')
            // Convert ## headings to section headings
            .replace(/^## (.+)$/gm, '<div class="review-section-heading">$1</div>')
            // Convert numbered sections (1. 2. 3. etc.)
            .replace(/^(\d+)\.\s+(.+)$/gm, '<div class="review-numbered-section">$1. $2</div>')
            // Convert red flag items with emoji
            .replace(/^‚óè üö©\s+(.+)$/gm, '<div class="review-red-flag">‚óè üö© $1</div>')
            // Convert bullet points with proper hierarchy
            .replace(/^‚óã\s+(.+)$/gm, '<div class="review-sub-bullet">‚óã $1</div>')
            .replace(/^‚ñ†\s+(.+)$/gm, '<div class="review-sub-sub-bullet">‚ñ† $1</div>')
            .replace(/^‚óè\s+(.+)$/gm, '<div class="review-bullet">‚óè $1</div>')
            // Convert **text** to bold emphasis
            .replace(/\*\*(.+?)\*\*/g, '<strong class="review-bold">$1</strong>')
            // Convert italic text (quotes)
            .replace(/\*([^*]+)\*/g, '<em class="review-italic">$1</em>')
            // Convert table-like structures
            .replace(/^Date\s+Adherence\s+Red\s+Flags\s+Suggested Improvements$/gm, 
                '<div class="review-table-header">Date | Adherence | Red Flags | Suggested Improvements</div>')
            // Convert table rows with checkmarks/crosses
            .replace(/^(\d{4}-\d{2}-\d{2})\s+(‚úÖ|‚ùå)\s+(.+)$/gm, 
                '<div class="review-table-row"><span class="review-date">$1</span><span class="review-status">$2</span><span class="review-description">$3</span></div>')
            // Add paragraph breaks for empty lines
            .replace(/\n\n/g, '</div><div class="review-paragraph">')
            // Clean up extra line breaks
            .replace(/\n/g, '<br>');
        
        // Wrap content in paragraph div
        content = '<div class="review-paragraph">' + content + '</div>';
        
        // Clean up empty divs
        content = content.replace(/<div class="review-paragraph"><\/div>/g, '');
        content = content.replace(/<div class="review-paragraph"><br><\/div>/g, '');
        
        element.innerHTML = content;
    });
}

function generateAIReviews() {
    if (!confirm('This will generate AI reviews for up to 10 observations in your organization. This may take a few minutes. Continue?')) {
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    button.disabled = true;
    
    fetch('{{ url_for("principal.generate_ai_reviews") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Success! ${data.message}\n\nProcessed: ${data.processed_count} observations\nTotal found: ${data.total_found} observations`);
            // Reload the page to show new AI reviews
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating AI reviews. Please try again.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
</script>
{% endblock %}
